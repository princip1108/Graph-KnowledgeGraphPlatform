<!DOCTYPE html>
<html lang="zh-CN" data-theme="corporate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发布帖子 - Graph+知识图谱平台</title>
    <link href="/assets/static/libs/daisyui@5.css" rel="stylesheet" type="text/css">
    <script src="/assets/static/libs/tailwind-browser@4.js"></script>
    <link href="/assets/static/libs/daisyui-themes.css" rel="stylesheet" type="text/css">
    <script src="/assets/3/3.1.1/iconify.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <style>
:root { --color-primary: rgba(30, 58, 138, 1); --color-base-200: rgba(247, 249, 250, 1); --color-base-300: rgba(229, 231, 235, 1); }
.header-shadow { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
#leftSidebar { width: 280px; min-width: 220px; max-width: 350px; }
#rightSidebar { width: 320px; min-width: 260px; max-width: 450px; }
.editor-toolbar { border-color: #E5E7EB !important; background-color: #F9FAFB !important; border-radius: 0.5rem 0.5rem 0 0 !important; }
.CodeMirror { border-color: #E5E7EB !important; border-radius: 0 0 0.5rem 0.5rem !important; height: calc(100vh - 300px) !important; font-family: Menlo, Monaco, Courier New, monospace; font-size: 14px; }
.tagify { --tags-border-color: #E5E7EB; --tags-focus-border-color: var(--color-primary); border-radius: 0.375rem; }
.preview-content { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif; line-height: 1.7; }
.preview-content h1, .preview-content h2, .preview-content h3 { margin-top: 20px; margin-bottom: 12px; font-weight: 600; }
.preview-content h1 { font-size: 1.75em; border-bottom: 1px solid #eee; padding-bottom: 8px; }
.preview-content h2 { font-size: 1.4em; border-bottom: 1px solid #eee; padding-bottom: 6px; }
.preview-content h3 { font-size: 1.2em; }
.preview-content p { margin-bottom: 12px; }
.preview-content code { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }
.preview-content pre { background: #f6f8fa; padding: 12px; border-radius: 6px; overflow-x: auto; }
.preview-content pre code { background: transparent; padding: 0; }
.preview-content blockquote { border-left: 4px solid #ddd; padding-left: 16px; color: #666; margin: 12px 0; }
.preview-content ul, .preview-content ol { padding-left: 24px; margin-bottom: 12px; }
.unsaved-indicator { display: none; }
.unsaved-indicator.show { display: inline-flex; }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">
    <!-- Header -->
    <div class="navbar bg-base-100 header-shadow px-4 sticky top-0 z-50 h-16">
        <div class="navbar-start gap-3">
            <a href="/community/forum_list.html" class="btn btn-ghost btn-sm gap-1">
                <span class="iconify" data-icon="heroicons:arrow-left" data-width="16"></span>
                返回论坛
            </a>
            <span class="text-xl font-bold text-base-content" id="pageTitle">发布新帖</span>
            <span class="unsaved-indicator badge badge-warning badge-sm" id="unsavedIndicator">未保存</span>
        </div>
        <div class="navbar-end gap-2">
            <button class="btn btn-ghost btn-sm" onclick="saveDraft()">
                <span class="iconify" data-icon="heroicons:bookmark" data-width="18"></span>
                存为草稿
            </button>
            <button class="btn btn-primary gap-2" onclick="publishPost()" id="publishBtn">
                <span class="iconify" data-icon="heroicons:paper-airplane" data-width="18"></span>
                发布
            </button>
        </div>
    </div>

    <!-- Three Column Layout -->
    <div class="flex-1 flex" style="height: calc(100vh - 64px);">
        <!-- Left Sidebar: Settings -->
        <div id="leftSidebar" class="bg-base-100 border-r border-base-300 p-4 overflow-y-auto space-y-4">
            <h3 class="font-bold text-sm uppercase text-base-content/60 mb-3">发布设置</h3>
            
            <!-- Graph Association -->
            <div class="form-control">
                <label class="label"><span class="label-text font-medium">关联图谱（可选）</span></label>
                <div class="flex gap-2">
                    <input type="text" id="graphSearch" class="input input-bordered input-sm flex-1" placeholder="搜索图谱..." />
                    <button class="btn btn-ghost btn-sm btn-square" onclick="searchGraphs()">
                        <span class="iconify" data-icon="heroicons:magnifying-glass" data-width="16"></span>
                    </button>
                </div>
                <div id="graphResults" class="mt-2 space-y-1 max-h-32 overflow-y-auto hidden"></div>
                <div id="selectedGraph" class="mt-2 hidden">
                    <div class="flex items-center gap-2 p-2 bg-primary/10 rounded-lg">
                        <span class="iconify text-primary" data-icon="heroicons:cube-transparent" data-width="16"></span>
                        <span class="flex-1 text-sm font-medium" id="selectedGraphName"></span>
                        <button class="btn btn-ghost btn-xs btn-circle" onclick="clearGraph()">
                            <span class="iconify" data-icon="heroicons:x-mark" data-width="14"></span>
                        </button>
                    </div>
                </div>
                <input type="hidden" id="graphId" value="" />
            </div>

            <!-- Tags -->
            <div class="form-control">
                <label class="label"><span class="label-text font-medium">标签</span></label>
                <input id="postTags" class="w-full" placeholder="添加标签（回车确认）" value="">
                <div class="label"><span class="label-text-alt">最多5个标签</span></div>
            </div>

            <!-- Abstract -->
            <div class="form-control">
                <label class="label"><span class="label-text font-medium">摘要</span></label>
                <textarea id="postAbstract" class="textarea textarea-bordered textarea-sm" rows="3" placeholder="自动从正文提取，或手动输入"></textarea>
                <div class="label"><span class="label-text-alt">显示在帖子列表中</span></div>
            </div>

            <!-- Tips -->
            <div class="alert alert-info text-xs p-3">
                <span class="iconify" data-icon="heroicons:light-bulb" data-width="16"></span>
                <span>支持 Markdown 语法，内容每30秒自动保存</span>
            </div>
        </div>

        <!-- Middle: Editor -->
        <div class="flex-1 flex flex-col overflow-hidden bg-base-200">
            <div class="p-4 flex-1 flex flex-col">
                <!-- Title -->
                <input type="text" id="postTitle" placeholder="请输入标题..." 
                    class="input input-lg w-full text-xl font-bold bg-base-100 border border-base-300 mb-4" />
                <!-- Editor -->
                <div class="flex-1 bg-base-100 rounded-lg border border-base-300 overflow-hidden">
                    <textarea id="postContent"></textarea>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Preview -->
        <div id="rightSidebar" class="bg-base-100 border-l border-base-300 flex flex-col">
            <div class="p-3 border-b border-base-300 flex items-center gap-2">
                <span class="iconify text-primary" data-icon="heroicons:eye" data-width="18"></span>
                <span class="font-bold text-sm">实时预览</span>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <h1 id="previewTitle" class="text-2xl font-bold mb-4 text-base-content/30">标题预览</h1>
                <div id="previewContent" class="preview-content text-base-content/50">
                    正文预览将显示在这里...
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast toast-top toast-end z-50 hidden">
        <div class="alert"><span id="toastMessage"></span></div>
    </div>

    <script>
        let easyMDE;
        let tagify;
        let postId = new URLSearchParams(window.location.search).get('id');
        let graphIdFromUrl = new URLSearchParams(window.location.search).get('graphId');
        let graphNameFromUrl = new URLSearchParams(window.location.search).get('graphName');
        let hasUnsavedChanges = false;
        let autoSaveTimer = null;

        document.addEventListener('DOMContentLoaded', async function() {
            easyMDE = new EasyMDE({ 
                element: document.getElementById('postContent'),
                placeholder: "在此输入正文（支持 Markdown）...",
                spellChecker: false,
                status: false,
                toolbar: ["bold", "italic", "heading", "|", "quote", "code", "unordered-list", "ordered-list", "|", "link", "image", "table", "|", "guide"],
                uploadImage: true,
                imageMaxSize: 5 * 1024 * 1024,
                imageAccept: "image/png, image/jpeg, image/gif, image/webp",
                imageUploadFunction: function(file, onSuccess, onError) {
                    var formData = new FormData();
                    formData.append('file', file);
                    fetch('/api/upload/image', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    })
                    .then(function(res) { return res.json(); })
                    .then(function(data) {
                        if (data.success) {
                            onSuccess(data.url);
                        } else {
                            onError(data.error || '上传失败');
                        }
                    })
                    .catch(function(err) { onError('网络错误'); });
                }
            });

            tagify = new Tagify(document.getElementById('postTags'), { maxTags: 5 });

            await checkLogin();

            // URL 参数自动填充图谱
            if (graphIdFromUrl) {
                document.getElementById('graphId').value = graphIdFromUrl;
                document.getElementById('selectedGraphName').textContent = graphNameFromUrl || '图谱 #' + graphIdFromUrl;
                document.getElementById('selectedGraph').classList.remove('hidden');
            }

            if (postId) {
                document.title = "编辑帖子 - Graph+知识图谱平台";
                document.getElementById('pageTitle').textContent = "编辑帖子";
                document.getElementById('publishBtn').innerHTML = '<span class="iconify" data-icon="heroicons:pencil-square" data-width="18"></span> 更新';
                loadPostData();
            }

            // 实时预览
            easyMDE.codemirror.on('change', function() {
                updatePreview();
                markUnsaved();
            });
            document.getElementById('postTitle').addEventListener('input', function() {
                document.getElementById('previewTitle').textContent = this.value || '标题预览';
                document.getElementById('previewTitle').classList.toggle('text-base-content/30', !this.value);
                document.getElementById('previewTitle').classList.toggle('text-base-content', !!this.value);
                markUnsaved();
            });

            // 自动保存（30秒）
            autoSaveTimer = setInterval(autoSave, 30000);

            // 退出拦截
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });

        function updatePreview() {
            var content = easyMDE.value();
            var previewEl = document.getElementById('previewContent');
            if (content) {
                previewEl.innerHTML = DOMPurify.sanitize(marked.parse(content));
                previewEl.classList.remove('text-base-content/50');
                previewEl.classList.add('text-base-content');
            } else {
                previewEl.innerHTML = '正文预览将显示在这里...';
                previewEl.classList.add('text-base-content/50');
                previewEl.classList.remove('text-base-content');
            }
        }

        function markUnsaved() {
            hasUnsavedChanges = true;
            document.getElementById('unsavedIndicator').classList.add('show');
        }

        function markSaved() {
            hasUnsavedChanges = false;
            document.getElementById('unsavedIndicator').classList.remove('show');
        }

        function autoSave() {
            if (!hasUnsavedChanges) return;
            var draft = {
                title: document.getElementById('postTitle').value,
                content: easyMDE.value(),
                tags: tagify.value.map(function(t) { return t.value; }),
                graphId: document.getElementById('graphId').value,
                abstract: document.getElementById('postAbstract').value,
                time: new Date().toISOString()
            };
            localStorage.setItem('post_draft_' + (postId || 'new'), JSON.stringify(draft));
            markSaved();
            showToast('草稿已自动保存', 'info');
        }

        async function checkLogin() {
            try {
                var response = await fetch('/user/api/check-auth', { credentials: 'include' });
                var data = await response.json();
                if (!data.authenticated) {
                    window.location.href = '/user/login_register.html?redirect=' + encodeURIComponent(window.location.href);
                }
            } catch (e) {
                window.location.href = '/user/login_register.html?redirect=' + encodeURIComponent(window.location.href);
            }
        }

        async function loadPostData() {
            try {
                var response = await fetch('/api/posts/' + postId, { credentials: 'include' });
                var data = await response.json();
                if (data.success) {
                    var post = data.post;
                    document.getElementById('postTitle').value = post.postTitle;
                    document.getElementById('previewTitle').textContent = post.postTitle;
                    document.getElementById('previewTitle').classList.remove('text-base-content/30');
                    easyMDE.value(post.postText || '');
                    updatePreview();
                    if (post.postAbstract) document.getElementById('postAbstract').value = post.postAbstract;
                    if (data.tags) tagify.addTags(data.tags.map(function(t) { return t.tagName; }));
                    if (post.graphId) {
                        document.getElementById('graphId').value = post.graphId;
                        document.getElementById('selectedGraphName').textContent = data.graphName || '图谱 #' + post.graphId;
                        document.getElementById('selectedGraph').classList.remove('hidden');
                    }
                    markSaved();
                } else {
                    showToast('加载失败: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('加载失败', 'error');
            }
        }

        async function searchGraphs() {
            var keyword = document.getElementById('graphSearch').value.trim();
            if (!keyword) return;
            try {
                var response = await fetch('/api/graph/search?keyword=' + encodeURIComponent(keyword) + '&size=5');
                var data = await response.json();
                var results = document.getElementById('graphResults');
                results.innerHTML = '';
                if (data.content && data.content.length > 0) {
                    data.content.forEach(function(g) {
                        var div = document.createElement('div');
                        div.className = 'p-2 hover:bg-base-200 rounded cursor-pointer text-sm';
                        div.textContent = g.name;
                        div.onclick = function() { selectGraph(g.graphId, g.name); };
                        results.appendChild(div);
                    });
                    results.classList.remove('hidden');
                } else {
                    results.innerHTML = '<div class="text-sm text-base-content/50 p-2">未找到图谱</div>';
                    results.classList.remove('hidden');
                }
            } catch (e) {
                showToast('搜索失败', 'error');
            }
        }

        function selectGraph(id, name) {
            document.getElementById('graphId').value = id;
            document.getElementById('selectedGraphName').textContent = name;
            document.getElementById('selectedGraph').classList.remove('hidden');
            document.getElementById('graphResults').classList.add('hidden');
            document.getElementById('graphSearch').value = '';
            markUnsaved();
        }

        function clearGraph() {
            document.getElementById('graphId').value = '';
            document.getElementById('selectedGraph').classList.add('hidden');
            markUnsaved();
        }

        async function publishPost() {
            var title = document.getElementById('postTitle').value.trim();
            var content = easyMDE.value();
            var tags = tagify.value.map(function(t) { return t.value; });
            var graphId = document.getElementById('graphId').value;
            var abstract = document.getElementById('postAbstract').value.trim() || content.substring(0, 150);

            if (!title) { showToast('请输入标题', 'warning'); return; }
            if (!content) { showToast('请输入正文内容', 'warning'); return; }

            var btn = document.getElementById('publishBtn');
            btn.disabled = true;
            btn.innerHTML = '&lt;span class="loading loading-spinner loading-sm"&gt;&lt;/span&gt; 处理中...';

            try {
                var url = postId ? '/api/posts/' + postId : '/api/posts';
                var method = postId ? 'PUT' : 'POST';
                var response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ title: title, content: content, tags: tags, abstract: abstract, graphId: graphId || null })
                });
                var data = await response.json();

                if (data.success) {
                    showToast(postId ? '更新成功！' : '发布成功！', 'success');
                    localStorage.removeItem('post_draft_' + (postId || 'new'));
                    hasUnsavedChanges = false;
                    setTimeout(function() {
                        window.location.href = '/community/post_detail.html?id=' + (data.post ? data.post.postId : postId);
                    }, 1000);
                } else {
                    showToast(data.error || '操作失败', 'error');
                    resetPublishBtn();
                }
            } catch (e) {
                showToast('网络错误', 'error');
                resetPublishBtn();
            }
        }

        function resetPublishBtn() {
            var btn = document.getElementById('publishBtn');
            btn.disabled = false;
            btn.innerHTML = postId 
                ? '<span class="iconify" data-icon="heroicons:pencil-square" data-width="18"></span> 更新'
                : '<span class="iconify" data-icon="heroicons:paper-airplane" data-width="18"></span> 发布';
        }

        function saveDraft() {
            autoSave();
            showToast('草稿已保存', 'success');
        }

        function showToast(message, type) {
            type = type || 'info';
            var toast = document.getElementById('toast');
            var alert = toast.querySelector('.alert');
            var msg = document.getElementById('toastMessage');
            alert.className = 'alert';
            if (type === 'success') alert.classList.add('alert-success');
            if (type === 'error') alert.classList.add('alert-error');
            if (type === 'warning') alert.classList.add('alert-warning');
            if (type === 'info') alert.classList.add('alert-info');
            msg.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(function() { toast.classList.add('hidden'); }, 3000);
        }
    </script>
</body>
</html>
