<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Common Scripts Fragment</title>
</head>
<body>
<!-- 公共脚本片段 -->
<th:block th:fragment="scripts">
<!-- 图谱 API 模块 -->
<script src="/assets/js/graph-api.js"></script>
<script th:inline="javascript">
(function() {
    'use strict';

    // 初始化全局命名空间
    window.APP_GLOBALS = window.APP_GLOBALS || {};

    // 页面路由映射
    const pageRoutes = {
        'home_page': /*[[@{/}]]*/ '/',
        'login_register_page': /*[[@{/login}]]*/ '/login',
        'registration_success_page': /*[[@{/registration-success}]]*/ '/registration-success',
        'password_reset_page': /*[[@{/password-reset}]]*/ '/password-reset',
        'graph_list_page': /*[[@{/graphs}]]*/ '/graphs',
        'graph_detail_page': /*[[@{/graph/1}]]*/ '/graph/1',
        'user_profile_page': /*[[@{/profile}]]*/ '/profile',
        'documentation_page': /*[[@{/documentation}]]*/ '/documentation',
        'about_page': /*[[@{/about}]]*/ '/about',
        'feedback_page': /*[[@{/feedback}]]*/ '/feedback',
        'page_998124': /*[[@{/admin}]]*/ '/admin',
        'page_998125': /*[[@{/forum}]]*/ '/forum'
    };

    // 全局导航函数
    window.navigateTo = function(targetPageId) {
        const targetUrl = pageRoutes[targetPageId];
        if (targetUrl) {
            window.location.href = targetUrl;
        } else {
            console.warn('Unknown page ID:', targetPageId);
        }
    };

    // 用户认证状态管理
    window.APP_GLOBALS.user = {
        isLoggedIn: false,
        userInfo: null,

        login: function(userInfo) {
            this.isLoggedIn = true;
            this.userInfo = userInfo;
            localStorage.setItem('userState', JSON.stringify({
                isLoggedIn: true,
                userInfo: userInfo
            }));
            this.updateUserInterface();
        },

        logout: function() {
            this.isLoggedIn = false;
            this.userInfo = null;
            localStorage.removeItem('userState');
            // 调用后端登出
            fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
                .finally(() => {
                    this.updateUserInterface();
                    window.location.href = '/graph/home.html';
                });
        },

        updateUserInterface: function() {
            const userControls = document.querySelectorAll('[data-user-control]');
            userControls.forEach(control => {
                const controlType = control.getAttribute('data-user-control');
                if (controlType === 'logged-out' && this.isLoggedIn) {
                    control.style.display = 'none';
                } else if (controlType === 'logged-in' && !this.isLoggedIn) {
                    control.style.display = 'none';
                } else {
                    control.style.display = '';
                }
            });
            
            // 更新导航栏头像
            if (this.isLoggedIn && this.userInfo) {
                this.updateNavbarAvatar();
            }
        },
        
        updateNavbarAvatar: function() {
            // 查找导航栏头像容器
            const avatarContainers = document.querySelectorAll('[data-user-control="logged-in"] .avatar > div');
            avatarContainers.forEach(container => {
                if (this.userInfo.avatar) {
                    // 有头像图片，显示图片
                    container.innerHTML = '<img src="' + this.userInfo.avatar + '" class="w-full h-full object-cover rounded-full" alt="头像">';
                } else if (this.userInfo.userName) {
                    // 无头像，显示用户名首字符
                    const avatarText = this.userInfo.userName.substring(0, 1);
                    container.textContent = avatarText;
                }
            });
        },

        init: function() {
            // 从服务端获取真实登录状态
            fetch('/user/api/check-auth', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data.authenticated) {
                        this.isLoggedIn = true;
                        this.userInfo = data.user || { userName: data.username };
                        localStorage.setItem('userState', JSON.stringify({
                            isLoggedIn: true,
                            userInfo: this.userInfo
                        }));
                    } else {
                        this.isLoggedIn = false;
                        this.userInfo = null;
                        localStorage.removeItem('userState');
                    }
                    this.updateUserInterface();
                })
                .catch(() => {
                    // 网络错误，使用本地缓存
                    const savedState = localStorage.getItem('userState');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        this.isLoggedIn = state.isLoggedIn;
                        this.userInfo = state.userInfo;
                    }
                    this.updateUserInterface();
                });
        }
    };

    // 搜索功能
    window.APP_GLOBALS.search = {
        history: JSON.parse(localStorage.getItem('searchHistory') || '[]'),
        recommendations: ['人工智能', '机器学习', '自然语言处理', '计算机视觉', '深度学习'],

        addToHistory: function(query) {
            if (query && !this.history.includes(query)) {
                this.history.unshift(query);
                this.history = this.history.slice(0, 10);
                localStorage.setItem('searchHistory', JSON.stringify(this.history));
            }
        },

        getSearchSuggestions: function() {
            return this.history.length > 0 ? this.history : this.recommendations;
        },

        performSearch: function(query, targetPage = 'graph_list_page') {
            this.addToHistory(query);
            navigateTo(targetPage);
        }
    };

    // 通知功能
    window.showNotification = function(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} fixed top-4 right-4 w-96 z-50 shadow-lg`;
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="iconify" data-icon="heroicons:information-circle-solid" data-width="20"></span>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    };

    // 收藏管理
    window.APP_GLOBALS.favorites = {
        items: JSON.parse(localStorage.getItem('favorites') || '[]'),

        add: function(graphId, graphData) {
            if (!this.items.find(item => item.id === graphId)) {
                this.items.push({
                    id: graphId,
                    data: graphData,
                    addedAt: new Date().toISOString()
                });
                localStorage.setItem('favorites', JSON.stringify(this.items));
                showNotification('已添加到收藏', 'success');
            }
        },

        remove: function(graphId) {
            this.items = this.items.filter(item => item.id !== graphId);
            localStorage.setItem('favorites', JSON.stringify(this.items));
            showNotification('已从收藏中移除', 'info');
        },

        isFavorited: function(graphId) {
            return this.items.some(item => item.id === graphId);
        },

        toggle: function(graphId, graphData) {
            if (this.isFavorited(graphId)) {
                this.remove(graphId);
            } else {
                this.add(graphId, graphData);
            }
        }
    };

    // DOM 加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        window.APP_GLOBALS.user.init();
    });

})();
</script>
</th:block>
</body>
</html>