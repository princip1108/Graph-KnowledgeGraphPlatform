# Graph Detail Page Refactoring Plan

**Objective**: Fix the persistent "Loading Forever" issue and establish a robust, safe architecture for `graph_detail.html`.

## 1. Root Cause Analysis
*   **The Problem**: The page remains in a loading state indefinitely (`1依然无法加载图谱`).
*   **Likely Causes**:
    1.  **CDN Blocking**: `unpkg.com` is frequently unstable or blocked in China. This causes the specific script to timeout or fail, stopping execution.
    2.  **Script Execution Order**: Dependent scripts might not be fully loaded when `initGraph` is called.
    3.  **Silent Failures**: Lack of `try-catch` blocks around the visualization initialization means any error (e.g., `ForceGraph` is undefined) halts the removal of the loading overlay.

## 2. Refactoring Strategy

### Phase 1: Stability & Safety (The Fix)
This phase addresses the immediate loading issue by removing external dependencies and adding error boundaries.

#### 1.1 Localize Dependencies (Critical)
**Action**: Do not rely on public CDNs for critical libraries.
*   **Task**: Download `force-graph.js` (and any dependencies like `d3`) to `src/main/resources/static/libs/force-graph/`.
*   **Benefit**: Eliminates network-related loading failures and ensures the app works offline/intranet.

#### 1.2 Robust Initialization Pattern
**Action**: Rewrite the initialization logic to be defensive.
*   **Task**: Wrap `initGraph` in a `try-catch` block.
*   **Task**: Ensure the loading spinner is **always** removed, even if initialization fails (in a `finally` block).
*   **Task**: Display a user-friendly error message ("Graph visualization failed to load") if the library fails to initialize, instead of an infinite spinner.

#### 1.3 Strict Data Validation
**Action**: Validate backend data before passing it to the visualization library.
*   **Task**: Check if `nodes` and `links` arrays exist and are not empty before rendering.
*   **Task**: Handle `null` or `undefined` properties gracefully within the rendering loop.

### Phase 2: Architecture Refactoring (The Optimization)
This phase cleans up the code structure for long-term maintainability, as requested ("Detailed plan").

#### 2.1 Modular JavaScript
**Action**: Extract the 500+ lines of inline JavaScript into a dedicated `graph-detail.js` file.
*   **Benefit**: Cleaner HTML, easier to lint and debug.
*   **Structure**:
    *   `GraphCore`: Handles ForceGraph instance and rendering.
    *   `GraphData`: Handles API calls and data transformation.
    *   `GraphUI`: Handles sidebars, modals, and event listeners.

#### 2.2 Decoupled Layout
**Action**: Enhance `layout/base.html` integration.
*   **Task**: Ensure the graph container correctly calculates its height based on the available space in the master layout (handled by flexbox/calc).
*   **Task**: Use `ResizeObserver` (already present but needs verification) to robustly handle sidebar filtering.

## 3. Execution Plan

1.  **Download Script**: Manually or via script, get `force-graph.min.js`.
2.  **Update Template**: Change `<script src="...">` to point to the local file.
3.  **Implement Error Boundary**: Modify `initGraph` logic in `graph_detail.html` immediately to prevent "infinite load" even if script fails.
4.  **Extract JS**: Move logic to `static/js/graph-detail.js`.

## 4. Verification Steps
*   **Network Test**: Disconnect internet or block CDN domains and verify graph loads (using local fallback).
*   **Error Test**: Intentionally break the data structure and verify a readable error message appears.
*   **Performance**: Verify sidebar toggles do not cause re-render lag.

## Safety Check
*   This plan does **not** modify backend logic (Service/Controller) to avoid regression there.
*   All changes are confined to `graph_detail.html` and static assets.
