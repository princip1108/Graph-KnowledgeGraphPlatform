# 已知问题与遗留清单

> 更新时间：2026-02-13

本文档记录项目中已确认的 Bug、临时方案、技术债务，供接手人参考。

---

## 1. 已修复的重要问题（近期）

以下问题已修复，列出供参考，避免回退：

| 时间 | 问题 | 修复方式 | 涉及文件 |
|------|------|---------|---------|
| 2026-02-13 | 论坛列表页评论数和点赞数不显示 | `PostController` 的 `/api/posts` 接口补充返回 `commentCount` 和 `createdAt` 字段 | `PostController.java` |
| 2026-02-13 | 图谱密度筛选失效（调整最小值即过滤掉所有图谱） | 数据库 `density` 字段永远为 0，改为前端动态计算密度 `relationCount / (nodeCount*(nodeCount-1)/2)`，滑动条范围改为 0.00~1.00 | `graph-list.js`, `graph_list.html`, `GraphListDto.java`, `GraphService.java` |

---

## 2. 未修复的已知问题

### 🔴 高优先级

#### 2.1 数据库 density 字段始终为 0
- **位置**：`GraphService.java` 创建图谱时 `graph.setDensity(BigDecimal.ZERO)`
- **现状**：数据库中 `knowledge_graph.density` 永远为 0，从未被更新
- **影响**：后端 `GraphSpecification` 中的密度筛选（`minDensity`/`maxDensity`）基于此字段，**完全无效**
- **当前临时方案**：前端 `graph-list.js` 在 `applyFilters` 中动态计算密度
- **建议**：在 `GraphService.updateGraphStats()` 中计算并持久化 density 值

#### 2.2 API 响应格式不统一
- **现状**：`项目结构说明书.md` 中定义了统一格式 `{ success, code, data, error }`，但实际代码中：
  - `GraphController` 直接返回 `Map.of(...)` 或 DTO
  - `PostController` 返回 `Map<String, Object>` 带 `success` 字段但无 `code`
  - `UserController` 返回 `ResponseEntity<?>` 带不同结构
- **影响**：前端处理响应时需逐接口适配，增加维护成本
- **建议**：统一使用 `Result<T>` 包装类（`common/Result.java` 已存在但未被使用）

#### 2.3 图谱关系数量（relationCount）可能不准确
- **位置**：`GraphService.updateGraphStats()` 方法
- **现状**：代码注释标注 `"关系数需要 RelationshipRepository，暂时跳过"`
- **影响**：图谱卡片上显示的关系数可能与实际 Neo4j 中的关系数不一致
- **建议**：注入 `RelationshipRepository` 并正确统计

### 🟡 中优先级

#### 2.4 日志使用 System.err 而非 SLF4J
- **现状**：以下文件使用了 `System.err.println` 或 `e.printStackTrace()`：
  - `PostController.java`（3 处）
  - `GraphService.java`（3 处）
  - `DownloadController.java`（1 处）
  - `FileUploadController.java`（1 处）
  - `HistoryController.java`（1 处）
  - `Neo4jConfig.java`（1 处）
  - `FileStorageServiceImpl.java`（1 处）
- **影响**：生产环境无法通过日志框架统一管理、分级、滚动
- **建议**：全局替换为 `private static final Logger log = LoggerFactory.getLogger(Xxx.class)`

#### 2.5 PostController 中 authorId 重复 put
- **位置**：`PostController.java` 第 86-87 行
- **现状**：`postMap.put("authorId", post.getAuthorId())` 出现两次（复制粘贴遗留）
- **影响**：无功能影响，但属于代码质量问题

#### 2.6 缓存文件机制未完成
- **位置**：`KnowledgeGraph` 实体包含 `cachedFilePath`、`cachedFileFormat`、`isCacheValid` 字段
- **现状**：无后台定时任务生成缓存文件
- **影响**：下载功能直接实时查询 Neo4j 生成数据，大图谱下载可能较慢

#### 2.7 热度算法定时更新未确认
- **位置**：`GraphService.updateAllHotScores()`
- **现状**：方法存在但未确认是否有 `@Scheduled` 定时调用
- **影响**：图谱热度排序可能不是实时的

### 🔵 低优先级

#### 2.8 `项目结构说明书.md` 中的 Controller 列表过时
- 文档中列出的 `RelationshipController.java` 和 `FileController.java` 实际不存在
- 实际为 `NodeController.java`（同时处理节点和关系）和 `FileUploadController.java`
- 新增的 Controller（Message, History, Feedback, Announcement, Download, DomainCategory）未列入

#### 2.9 搜索功能使用 SQL LIKE
- 未集成全文检索引擎（如 Elasticsearch）
- 数据量大时性能会下降，不支持分词/纠错

---

## 3. 测试覆盖情况

| 类型 | 状态 |
|------|------|
| 单元测试 | ❌ `src/test` 目录仅有默认生成的空测试类 |
| 集成测试 | ❌ 无 |
| API 测试 | ❌ 无 Postman/Swagger 集合 |
| 前端测试 | ❌ 无 |

**建议**：接手后优先为核心 Service（GraphService、PostService、UserService）补充单元测试。

---

## 4. 安全注意事项

| 项目 | 说明 |
|------|------|
| **Session 认证** | 当前使用 Session-Cookie 认证，如需前后端分离建议迁移 JWT |
| **CSRF** | 需确认 SecurityConfig 中 CSRF 的配置状态 |
| **密码存储** | 使用 BCrypt 加密 ✅ |
| **敏感信息** | 环境变量注入 ✅（application.yaml 中无硬编码密码） |
| **文件上传** | 有类型校验和大小限制 ✅，但无病毒扫描 |
| **SQL 注入** | 使用 JPA/Hibernate 参数化查询 ✅ |

---

## 5. 性能已知瓶颈

| 场景 | 原因 | 建议 |
|------|------|------|
| 大图谱加载慢 | Neo4j 一次查询所有节点/关系返回前端 | 分页加载或按区域渲染 |
| 图谱列表筛选 | 前端 JS 过滤而非后端分页筛选 | 将结构筛选参数传到后端 GraphSpecification |
| 帖子列表 N+1 查询 | `PostController` 循环中逐个查作者信息和评论数 | 批量查询或 JOIN |
| 无缓存层 | 热门图谱每次请求都查数据库 | 引入 Redis 缓存 |

---

## 6. 环境/配置注意

- **Spring Boot 版本**：`4.0.0`（较新，部分社区库可能不兼容）
- **Java 版本**：21（需确保服务器 JDK 版本一致）
- **Neo4j 协议**：`application.yaml` 使用 `neo4j://`，`application-prod.yaml` 使用 `bolt://`，注意区别
- **`ddl-auto: update`**：生产环境建议改为 `validate` 或 `none`，用脚本管理 Schema 变更
