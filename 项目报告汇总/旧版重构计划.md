# 重构计划：知识图谱平台 (KGPlatform)

> [!IMPORTANT]
> 本计划仅针对 `demo` 模块进行重构，`Graph+` 目录将被忽略作为备份参考。

## 1. 前端重构 (Frontend Refactoring)

**现状分析**:
`demo/src/main/resources/templates` 下的页面（如 `graph_list.html`, `home.html`）虽然使用了 `fragments`（页头、页脚），但每个页面仍重复定义了 `<html>`, `<head>`, `<body>` 结构以及脚本引入逻辑。缺乏统一的布局管理。

### 1.1. 引入布局方言 (Layout Dialect)
**目标**: 消除页面结构重复，统一管理 CSS/JS 引用。
- **操作**: 在 `pom.xml` 中添加依赖：
    ```xml
    <dependency>
        <groupId>nz.net.ultraq.thymeleaf</groupId>
        <artifactId>thymeleaf-layout-dialect</artifactId>
    </dependency>
    ```

### 1.2. 重构基础布局 (`layout/base.html`)
**目标**: 将 `base.html` 转换为真正的布局模板。
- **文件**: `src/main/resources/templates/layout/base.html`
- **改动**:
    - 添加 `xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"` 命名空间。
    - 将 `<th:block th:replace="${content} ...">` 替换为 `<div layout:fragment="content"></div>`。
    - 预留 `<th:block layout:fragment="css"></th:block>` 和 `<th:block layout:fragment="js"></th:block>` 用于子页面扩展。

### 1.3. 页面标准化 (Page Standardization)
**目标**: 让所有业务页面继承 `base.html`，只关注核心内容。
- **涉及页面**:
    - `graph/home.html` (首页)
    - `graph/graph_list.html` (图谱列表)
    - `graph/graph_detail.html` (图谱详情)
    - `user/profile.html` (用户中心)
    - `community/*.html` (论坛相关)
- **代码重构示例** (`graph_list.html`):
    ```html
    <!-- 删除 <html>, <head>, <body>, header/footer引入 -->
    <!-- 改为: -->
    <html xmlns:th="http://www.thymeleaf.org" 
          xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{layout/base}">
    <head>
        <title>知识图谱探索</title>
        <!-- 页面独有样式 -->
        <link rel="stylesheet" th:href="@{/css/graph-list.css}">
    </head>
    <body>
        <div layout:fragment="content">
            <!-- 原 main 标签内的内容保留 -->
            <section class="bg-base-100 py-16 px-4">...</section>
            <section class="py-8 px-4">...</section>
        </div>
        
        <th:block layout:fragment="js">
            <script th:src="@{/js/graph-list.js}"></script>
        </th:block>
    </body>
    </html>
    ```

## 2. 后端重构 (Backend Refactoring)

**现状分析**:
`FileUploadController.java` (500+行) 包含大量非控制层逻辑，如文件IO操作、JSON手动生成/解析、复杂的图谱构建业务。

### 2.1. 提取文件存储服务 (`FileStorageService`)
**目标**: 封装所有文件系统操作。
- **新建类**: `com.sdu.kgplatform.service.impl.FileStorageServiceImpl`
- **核心方法**:
    - `public String storeFile(MultipartFile file, String subDir)`
        - **代码段**: 移动 `FileUploadController` 中 `uploadAvatar`, `uploadImage`, `uploadCover` 方法里的 `Files.copy` 逻辑。
    - `public void init()`: 负责创建上传目录 (原 lines 94-98, 152-155)。

### 2.2. 提取图谱导入服务 (`GraphImportService`)
**目标**: 封装图谱解析与创建的复杂业务逻辑。
- **新建类**: `com.sdu.kgplatform.service.impl.GraphImportServiceImpl`
- **核心方法**:
    - `public GraphDetailDto importGraph(MultipartFile file, User user, GraphCreateDto metadata)`
    - **代码段**: 移动 `uploadGraph` 方法中的核心业务逻辑 (原 lines 277-427)。
        - 图谱基本信息创建
        - 节点解析与存储循环
        - 关系解析与存储循环

### 2.3. 优化 JSON 处理
**目标**: 移除不安全的正则解析，使用 Jackson 库。
- **操作**:
    - 删除 `FileUploadController` 中的 private 方法 `parseJson` (原 lines 440-527)。
    - 在 `GraphImportService` 中使用 ObjectMapper:
      ```java
      // 替代方案
      ObjectMapper mapper = new ObjectMapper();
      GraphImportJsonData data = mapper.readValue(file.getInputStream(), GraphImportJsonData.class);
      ```
    - **新建 DTO**: `com.sdu.kgplatform.dto.importdata.GraphImportJsonData` (包含 nodes, relations 等字段)。

## 3. 执行步骤 (Execution Steps)

1.  **后端 - 基础设施**: 创建 `FileStorageService` 和 `GraphImportService` 接口及实现。
2.  **后端 - 清理**: 重构 `FileUploadController`，注入新服务，删除冗余代码。
3.  **前端 - 依赖**: 修改 `pom.xml` 加入 Layout Dialect。
4.  **前端 - 布局**: 修改 `layout/base.html` 为布局模板。
5.  **前端 - 页面**: 逐个迁移 `home.html`, `graph_list.html` 等页面使用新布局。

## 4. 验证计划 (Verification Plan)

### 自动化测试
- **后端**: 运行 `mvn test` (如有)。
- **新建测试**: 为 `GraphImportService` 编写单元测试，模拟 MultipartFile 上传 JSON 并验证 Service 调用。

### 手动验证
- **启动应用**: `mvn spring-boot:run`
- **前端验证**:
    - 访问首页 `/graph/home.html`，确认页面样式正常，Header/Footer 加载正确。
    - 访问列表页 `/graph/graph_list.html`，确认布局无崩坏。
- **功能验证**:
    - 登录后上传头像，验证 `FileStorageService`。
    - 上传 JSON 图谱文件，验证 `GraphImportService` 及 Jackson 解析是否正确。
