# 数据库索引优化专项计划

**创建日期**: 2026-02-04
**目标**: 解决查询卡顿问题，消除 Neo4j 全表扫描，提升 MySQL 多条件查询效率。

---

## 1. Neo4j 索引优化 (核心痛点)

目前 Neo4j 查询中大量使用 `WHERE n.graphId = $id` 或 `WHERE n.nodeId = $id`，由于缺乏索引，导致每次操作都在进行 Label Scan (全表扫描)。这是导致“查询慢”的根本原因。

### 1.1 必须执行的 Cypher 命令

请在 Neo4j Browser (http://localhost:7474) 或 命令行 Cypher Shell 中执行以下命令：

#### A. 创建约束 (Constraint) - 保证唯一性且速度最快
针对业务主键 `nodeId`，必须保证唯一性。

```cypher
// 为 Entity 节点的 nodeId 属性创建唯一性约束（自动包含索引）
CREATE CONSTRAINT entity_nodeid_unique IF NOT EXISTS
FOR (n:Entity) REQUIRE n.nodeId IS UNIQUE;
```

#### B. 创建常规索引 (Index) - 解决过滤查询慢
针对高频查询字段 `graphId`, `name`, `type`。

```cypher
// 1. 核心索引：图谱ID (解决 findByGraphId 慢的问题)
CREATE INDEX entity_graphid_index IF NOT EXISTS
FOR (n:Entity) ON (n.graphId);

// 2. 搜索索引：节点名称 (解决 findByName 和 模糊搜索慢的问题)
CREATE INDEX entity_name_index IF NOT EXISTS
FOR (n:Entity) ON (n.name);

// 3. 筛选索引：节点类型
CREATE INDEX entity_type_index IF NOT EXISTS
FOR (n:Entity) ON (n.type);
```

#### C. 关系索引 (Neo4j 4.3+)
针对关系上的属性查询。

```cypher
// 关系类型上的 graphId 索引 (解决 Delete/Count 等操作的过滤效率)
CREATE INDEX rel_graphid_index IF NOT EXISTS
FOR ()-[r:RELATES_TO]-() ON (r.graphId);
```

### 1.2 验证方法
执行查询前加上 `PROFILE` 关键字，观察 Execution Plan。
- **优化前**: 会看到 `NodeByLabelScan` (全表扫描)。
- **优化后**: 应看到 `NodeIndexSeek` 或 `NodeIndexScan` (索引查找)。

---

## 2. MySQL 索引优化 (辅助优化)

针对列表页加载慢、搜索慢的问题。假设表名为 `knowledge_graphs` (对应实体 `KnowledgeGraph`)。

### 2.1 必须执行的 SQL 命令

```sql
-- 1. 用户查询优化：用户中心查看 "我的图谱"
ALTER TABLE knowledge_graphs ADD INDEX idx_uploader_id (uploader_id);

-- 2. 状态查询优化：公共大厅查看 "公开图谱"
ALTER TABLE knowledge_graphs ADD INDEX idx_status (status);

-- 3. 组合索引：热门图谱查询 (status + view_count)
-- 优化 SELECT * FROM kg WHERE status='PUBLISHED' ORDER BY view_count DESC
ALTER TABLE knowledge_graphs ADD INDEX idx_status_view (status, view_count DESC);

-- 4. 唯一索引：分享链接 (避免全表扫)
ALTER TABLE knowledge_graphs ADD UNIQUE INDEX uk_share_link (share_link);
```

---

## 3. 执行计划

1.  **备份数据**: 在执行任何操作前，请先备份 Neo4j `data` 目录和 MySQL 数据库。
2.  **停机维护**: 建议在低峰期执行。
3.  **执行命令**:
    *   登录 Neo4j Browser 执行 1.1 中的 Cypher 语句。
    *   登录 MySQL Client 执行 2.1 中的 SQL 语句。
4.  **重启服务**: 重启应用服务以确保连接池特别是缓存层（如果有）刷新。
5.  **性能回归测试**: 打开大图谱（节点数>1000），对比加载时间。

## 4. 预期效果
- **单节点查询**: < 10ms
- **图谱详情页加载**: 数据库读取耗时减少 90% 以上 (主要瓶颈将转移到网络传输和前端渲染，见《待实现功能清单》中的 Over-fetching 优化项)。
